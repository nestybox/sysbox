#!/bin/bash

#
# Preps host for Sysbox dev environment
#

GO=/usr/local/go/bin/go

echo "Preparing host for Sysbox dev environment ..."

# Check if Golang is present
echo "  Checking for Golang ..."
output=$(sh -c "stat /usr/local/go/bin/go" 2>&1)
if [ $? -ne 0 ]; then
  echo "  Error: please install Golang."
  exit 1
fi

# Check if Docker is present
echo "  Checking for Docker ..."
output=$(sh -c "which docker" 2>&1)
if [ $? -ne 0 ]; then
  echo "  Error: please install Docker."
  exit 1
fi

output=$(sh -c "docker ps" 2>&1)
if [ $? -ne 0 ]; then
  echo "  Error: please make sure you have permission to run Docker."
  exit 1
fi

# Install utilities required for libseccomp
echo "  Checking for make and autoconf utilities ..."
output=$(sh -c "which make && which autoconf && dpkg -l libtool" 2>&1)
if [ $? -ne 0 ]; then
  echo "  Installing make and autoconf utilities ..."
  sudo apt-get install --no-install-recommends -y \
    make \
    libtool
    if [ $? -ne 0 ]; then
      echo "  Error: failed to install utilities."
      exit 1
    fi
fi

# install protoc compiler for gRPC
echo "  Checking for gRPC protoc compiler ..."

sudo apt-get install --no-install-recommends -y unzip

output=$(sh -c "which protoc" 2>&1)
if [ $? -ne 0 ]; then
  echo "  Installing gRPC protoc compiler ..."
  mkdir -p ~/bin/protoc \
    && cd ~/bin/protoc/ \
    && wget https://github.com/protocolbuffers/protobuf/releases/download/v3.6.1/protoc-3.6.1-linux-x86_64.zip \
    && unzip protoc-3.6.1-linux-x86_64.zip \
    && cp -r include/* /usr/local/include/ \
    && cp bin/protoc /usr/local/bin/ \
    && cd \
    && rm -rf ~/bin/protoc/ \
    && GIT_TAG="v1.3.1" \
    && ${GO} get -d -u github.com/golang/protobuf/protoc-gen-go \
    && git -C "$GOPATH"/src/github.com/golang/protobuf checkout $GIT_TAG > /dev/null \
    && ${GO} install github.com/golang/protobuf/protoc-gen-go
  if [ $? -ne 0 ]; then
    echo "  Error: failed to install protoc."
    exit 1
  fi
fi

printf "Done.\n"
printf "\n"
printf "Use the sysbox make targets (e.g., make sysbox, make test-sysbox, etc.) to build or test.\n"
