#!/usr/bin/make -f

# Output every command that modifies files on the build system. Enable me for
# debugging purposes.
export DH_VERBOSE = 1

# Shiftfs module name.
export SHIFTFS_MOD_NAME = shiftfs

override_dh_auto_build:
	# Build sysvisor's components.
	cd sysvisor && make sysvisor

override_dh_auto_test:

# ONESHELL attribute to ensure that all instruccions in this target are executed
# within a single shell process.
.ONESHELL:
SHELL=/bin/bash
override_dh_auto_install:
	# Sysvisor binaries will be installed through the regular (makefile) process.
	install -D -m0755 sysvisor/sysvisor-fs/sysvisor-fs \
		debian/sysvisor/usr/local/sbin/sysvisor-fs
	install -D -m0755 sysvisor/sysvisor-mgr/sysvisor-mgr \
		debian/sysvisor/usr/local/sbin/sysvisor-mgr
	install -D -m0755 sysvisor/sysvisor-runc/sysvisor-runc \
		debian/sysvisor/usr/local/sbin/sysvisor-runc

	# Sysvisor services installation.
	install -D -m 0644 /sources/sysvisor.service \
		debian/sysvisor/lib/systemd/system/sysvisor.service
	install -D -m 0644 /sources/sysvisor-fs.service \
		debian/sysvisor/lib/systemd/system/sysvisor-fs.service
	install -D -m 0644 /sources/sysvisor-mgr.service \
		debian/sysvisor/lib/systemd/system/sysvisor-mgr.service

	# Sysvisor's sysctl.d config-file installation.
	install -D -m 0644 /sources/sysvisor-systemd.conf \
		debian/sysvisor/lib/systemd/system/sysvisor-systemd.conf

	# Iterate through all the kernel-headers present in the build-server and
	# install the shiftfs modules previously compiled.
	for d in /lib/modules/*; do

		kernel_major_no=$$(echo $$d | cut -d"/" -f4 | cut -d"." -f1)
		if [[ $${kernel_major_no} -lt 5 ]]; then
			echo "Skipping kernel $${d}"
			continue
		fi

		if [[ -f "$${d}/updates/dkms/$${SHIFTFS_MOD_NAME}.ko" ]]; then
			echo "Installing $${SHIFTFS_MOD_NAME} module for kernel $${d}"
			install -D -m 0644 $${d}/updates/dkms/$${SHIFTFS_MOD_NAME}.ko \
				debian/sysvisor/$${d}/updates/dkms/$${SHIFTFS_MOD_NAME}.ko
		fi
	done


override_dh_install:
	dh_install

# Override dh_usrlocal to prevent error after placing sysvisor binaries in
# /usr/local path.
override_dh_usrlocal:

%:
	dh $@

override_dh_installsystemd:
	dh_installsystemd sysvisor.service sysvisor-mgr.service sysvisor-fs.service
